---
title: "Visualiza√ß√£o de dados"
subtitle: "Aula 3"
author: "Bruno Montezano"
institute: "Grupo Alliance<br>Programa de P√≥s-Gradua√ß√£o em Psiquiatria e Ci√™ncias do Comportamento<br>Universidade Federal do Rio Grande do Sul"
date: last-modified
date-format: long
lang: pt-br
execute:
  echo: true
format:
  revealjs:
    incremental: true
    smaller: true
    theme: [default, ../assets/custom.scss]
    logo: "../assets/logo_ufrgs.png"
bibliography: references.bib
---

## Conte√∫do de hoje

-   Pacote `ggplot2`
    -   Gram√°tica dos gr√°ficos
    -   Est√©tica
    -   Mapeamento
-   Gr√°ficos b√°sicos
-   Personaliza√ß√£o de gr√°ficos
-   Exemplos pr√°ticos
-   Extens√µes de ggplot2

## Que a For√ßa esteja com voc√™!

::: columns
::: {.column width="70%"}
Para a aula de hoje, vamos usar os `dados_starwars`.

Este conjunto de dados cont√©m 14 vari√°veis de 87 personagens dos filmes da saga Star Wars.

No decorrer da aula, vamos introduzir outras bases de dados para exemplificar
cada tipo de gr√°fico.
:::

::: {.column width="30%"}
![](../assets/star_wars_poster.jpg)
:::
:::

## `dados_starwars`

```{r carregar-starwars}
library(dados)
library(dplyr)

dados_starwars
```

## `ggplot2`

![](../assets/logo_ggplot2.png){fig-align="center" width="45%"}

## Exemplos iniciais de `ggplot2`

::: columns
::: {.column width="50%"}
```{r exemplo-inicial-ggplot2-codigo}
#| eval: false
library(ggplot2)

dados_starwars |>
  ggplot() +
  aes(x = massa, y = altura) +
  geom_point(color = "forestgreen", size = 3) +
  xlab("Massa (kg)") +
  ylab("Altura (cm)") +
  ggtitle("Altura e massa dos personagens") +
  theme_bw(base_size = 18)
```

<br>

```{r exemplo-inicial-ggplot2-codigo-com-filter}
#| eval: false
dados_starwars |>
  filter(!is.na(genero)) |>
  ggplot() +
  aes(x = massa, y = altura, color = genero) +
  geom_point(size = 4, alpha = 0.7) +
  xlab("Massa (kg)") +
  ylab("Altura (cm)") +
  ggtitle("Altura e massa dos personagens",
          "Estratificado por g√™nero") +
  theme_minimal(base_size = 20) +
  scale_color_discrete(name = "G√™nero")
```
:::

::: {.column width="50%"}
```{r exemplo-inicial-ggplot2-output}
#| echo: false
#| out-width: 100%
#| fig-align: "center"
library(ggplot2)

ggplot(data = dados_starwars,
       aes(x = massa, y = altura)) +
  geom_point(color = "forestgreen", size = 3) +
  xlab("Massa (kg)") +
  ylab("Altura (cm)") +
  ggtitle("Altura e massa dos personagens") +
  theme_bw(base_size = 18) #+
  #theme(plot.background = element_rect(fill = "#f0f1eb"))

ggplot(data = dados_starwars |> 
         filter(!is.na(genero)),
       aes(x = massa, y = altura, color = genero)) +
  geom_point(size = 4, alpha = 0.7) +
  xlab("Massa (kg)") +
  ylab("Altura (cm)") +
  ggtitle("Altura e massa dos personagens",
          "Estratificado por g√™nero") +
  theme_minimal(base_size = 20) +
  scale_color_discrete(name = "G√™nero")
  #theme(plot.background = element_rect(fill = "#f0f1eb"))
```
:::
:::

## Gram√°tica de gr√°ficos em camadas

O pacote `ggplot2` segue duas filosofias que facilitam a compreens√£o do processo de constru√ß√£o de gr√°ficos:

::: nonincremental
- Um gr√°fico estat√≠stico √© uma representa√ß√£o visual dos dados por meio de atributos est√©ticos (posi√ß√£o, cor, forma, tamanho) de formas geom√©tricas (pontos, linhas, curvas) [@thegram2005]

- Um gr√°fico pode ser constru√≠do em camadas (sobreposi√ß√£o de elementos visuais) [@layered-grammar]
:::

## Camadas

::: {.panel-tabset}

## Canvas

```{r canvas}
#| out-width: 75%
#| fig-align: "center"
dados_starwars |> 
  ggplot()
```

## Eixos

```{r eixos}
#| out-width: 75%
#| fig-align: "center"
dados_starwars |> 
  ggplot() +
  aes(x = massa, y = altura)
```

## Geometria

```{r geometria}
#| out-width: 75%
#| fig-align: "center"
dados_starwars |> 
  ggplot() +
  aes(x = massa, y = altura) +
  geom_point()
```


:::

## Por que o `+`?

O `ggplot2`, diferentemente dos outros pacotes do Tidyverse, n√£o usa o *pipe*
(`|>`) porque o `ggplot2` surgiu [antes que o autor tomasse conhecimento do
pipe](https://www.reddit.com/r/dataisbeautiful/comments/3mp9r7/comment/cvi19ly/?utm_source=share&utm_medium=web2x&context=3).

<iframe id="reddit-embed" src="https://www.redditmedia.com/r/dataisbeautiful/comments/3mp9r7/im_hadley_wickham_chief_scientist_at_rstudio_and/cvi19ly/?depth=1&amp;showmore=false&amp;embed=true&amp;showmedia=false" sandbox="allow-scripts allow-same-origin allow-popups" style="border: none;" height="437" width="640" scrolling="no"></iframe>

## Dica: Como escolher o gr√°fico mais adequado?

<center>
<figure>
    <a href="https://www.data-to-viz.com/">
    <img src="../assets/from_data_to_viz.png" style="width:100%">
    </a>
</figure>
</center>

## Gr√°fico de pontos (dispers√£o)

Geralmente usado para visualizar a associa√ß√£o de duas vari√°veis cont√≠nuas.

. . .

Como por exemplo, verificar a associa√ß√£o entre altura e massa nos personagens
do Star Wars.

. . .

```{r scatterplot-altura-massa}
#| fig-align: "center"
#| out.width: "70%"
dados_starwars |> # Usar os `dados_starwars`
  filter(massa < 1000) |> # Manter apenas observa√ß√µes com menos de 1.000kg de massa
  ggplot() + # Iniciar o canvas
  aes(x = massa, y = altura) + # Mapear massa no eixo x e altura no eixo y
  geom_point() # Usar a geometria de pontos para criar um gr√°fico de dispers√£o
```

## `ggplot2` √© extremamente vers√°til

<center>
<figure>
    <a href="https://github.com/brunomontezano/grafico-star-wars">
    <img src="https://raw.githubusercontent.com/brunomontezano/grafico-star-wars/main/plot_final.png" style="width:100%">
    </a>
</figure>
</center>

## `dados_gapminder`


::: columns
::: {.column width="55%"}
Para aprender o pr√≥ximo gr√°fico, vamos usar os `dados_gapminder`.

Trata-se de um projeto sueco criado por Hans Rosling que coleta
dados sobre diversas tend√™ncias globais. Na parte dos dados que vamos utilizar,
temos informa√ß√µes de 1952 a 2007 (intervalos de 5 anos).

Estes dados possuem 1.704 observa√ß√µes e 6 vari√°veis, sendo elas: `pais`,
`continente`, `ano`, `expectativa_de_vida`, `populacao`, `pib_per_capita`.
:::

::: {.column width="45%"}
![](../assets/logo_gapminder.png)
:::
:::

## Exibindo `dados_gapminder`

```{r printar-gapminder}
dados_gapminder
```

## Gr√°fico de linhas

Utilizamos o `geom_line()` para fazer gr√°ficos de linhas. Eles s√£o √≥timos para
representar *s√©ries temporais*, ou seja, observa√ß√µes medidas repetidamente em
intervalos de tempo.

. . .

Tal qual no gr√°fico de pontos, precisamos definir as posi√ß√µes $x$ e $y$ para
construirmos os gr√°ficos de linhas.

. . .

No pr√≥ximo slide, vamos olhar um exemplo de gr√°fico de linha do PIB per capita
do Brasil ao decorrer dos anos.

## PIB per capita do Brasil

::: {.panel-tabset}
## Linhas
```{r pib-do-brasil}
#| fig-align: "center"
#| out.width: "70%"
dados_gapminder |> 
  filter(pais == "Brasil") |> 
  ggplot() +
  aes(x = ano, y = pib_per_capita) +
  geom_line()
```

## Eixos
```{r pib-do-brasil-eixos}
#| fig-align: "center"
#| out.width: "65%"
dados_gapminder |> 
  filter(pais == "Brasil") |> 
  ggplot() +
  aes(x = ano, y = pib_per_capita) +
  geom_line() +
  scale_x_continuous(breaks = seq(1952, 2007, 5)) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "R$ ",
                                             decimal.mark = ",",
                                             big.mark = "."))
```

## Tema e r√≥tulos
```{r pib-do-brasil-tema-rotulos}
#| fig-align: "center"
#| out.width: "50%"
dados_gapminder |> 
  filter(pais == "Brasil") |> 
  ggplot() +
  aes(x = ano, y = pib_per_capita) +
  geom_line(linewidth = 2, color = "darkslateblue") +
  scale_x_continuous(breaks = seq(1952, 2007, 5)) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "R$ ",
                                             decimal.mark = ",",
                                             big.mark = ".")) +
  labs(x = "Ano", y = "PIB per capita",
       title = "PIB per capita do Brasil ao passar dos anos",
       subtitle = "De 1952 a 2007",
       caption = "Fonte: Gapminder") +
  theme_minimal(base_size = 16, base_family = "Charter")
```
:::

## Como os filmes da Pixar foram avaliados?

::: columns
::: {.column width="55%"}
Para o pr√≥ximo gr√°fico, vamos tentar responder a seguinte pergunta:

"Segundo a CinemaScore, qual a nota mais recebida pelos filmes da Pixar?"

Para isso, vamos usar outra base de dados do pacote `dados`, chamada
`pixar_avalicao_publico`.
:::

::: {.column width="45%"}
![](../assets/logo_pixar.png)
:::
:::

## `pixar_avalicao_publico`

```{r mostrar-avaliacao-pixar}
pixar_avalicao_publico
```

. . .

```{r count-avaliacao-cinema-score}
pixar_avalicao_publico |> 
  count(nota_cinema_score) # A fun√ß√£o count() serve para contar os valores √∫nicos de uma vari√°vel
```

## Gr√°fico de barras

O gr√°fico de barras √© muito usado para apresentar a frequ√™ncia de uma
determinada categoria de uma vari√°vel.

. . .

No exemplo a seguir, acrescentamos o `ggplot2` ao c√≥digo do slide anterior
para criar um gr√°fico de barras com a frequ√™ncia de cada nota (A-, A, A+) dos
filmes da Pixar segundo o CinemaScore.

## Exemplo de gr√°fico de barras

```{r grafico-barras-cinema-score}
#| out-width: 60%
#| fig-align: "center"
pixar_avalicao_publico |> 
  count(nota_cinema_score) |> 
  ggplot() +
  aes(x = nota_cinema_score, y = n) |> 
  geom_col()
```

## Gr√°fico de barras ap√≥s ajustes

::: {.panel-tabset}

## C√≥digo

```{r grafico-barras-cinema-score-ajustado}
#| out-width: 60%
#| fig-align: "center"
#| eval: false
pixar_avalicao_publico |> # Pegar base da Pixar de avalia√ß√£o do p√∫blico
  rename(nota = nota_cinema_score) |> # Renomear vari√°vel nota_cinema_score
  count(nota) |> # Contar o n√∫mero de filmes com cada nota
  mutate(
    nota = forcats::fct_na_value_to_level(nota,
                                          "Sem escore"), # Transformar NA no valor "Sem escore"
    nota = factor(nota,
                  levels = c("A-", "A",
                             "A+",
                             "Sem escore")), # Reordenar as notas da menor para a maior
    cor = dplyr::case_when(nota == "A" ~ "Colorido",
                           .default = "Cinza") # Criar vari√°vel para colorir barra principal
  ) |>
  ggplot() + # Iniciar o canvas do ggplot2
  aes(x = nota, y = n, fill = cor) |> # Mapear vari√°veis do gr√°fico
  geom_col(width = 0.5, show.legend = FALSE) + # Adicionar a geometria do gr√°fico de barras
  scale_fill_manual(values = c("gray25", "darkorange")) + # Modificar as cores do preenchimento
  labs(title = "A maioria dos filmes (n = 13) receberam nota A.",
       x = "Nota segundo CinemaScore",
       y = "N√∫mero de filmes") + # Adicionar r√≥tulos
  theme_classic(base_size = 18, base_family = "Charter") # Modificar tema, tamanho e fam√≠lia da fonte
```

## Gr√°fico

```{r grafico-barras-cinema-score-ajustado-output}
#| out-width: 100%
#| fig-align: "center"
#| echo: false
pixar_avalicao_publico |> 
  count(nota_cinema_score) |> 
  mutate(nota_cinema_score = forcats::fct_na_value_to_level(
    nota_cinema_score, "Sem escore"),
    nota_cinema_score = factor(nota_cinema_score,
                               levels = c("A-", "A",
                                          "A+",
                                          "Sem escore")),
    cor = dplyr::case_when(
    nota_cinema_score == "A" ~ "Colorido",
    .default = "Cinza"
  )) |> 
  ggplot() +
  aes(x = nota_cinema_score, y = n, fill = cor) |> 
  geom_col(width = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = c("gray25", "darkorange")) +
  labs(title = "A maioria dos filmes (n = 13) receberam nota A.",
       x = "Nota segundo CinemaScore",
       y = "N√∫mero de filmes") +
  theme_classic(base_size = 18, base_family = "Charter")
```

:::

## Histograma

Histogramas s√£o √∫teis para avaliarmos a distribui√ß√£o de uma vari√°vel num√©rica.

. . .

Para criar histogramas, usamos o `geom_histogram()`. Para isso, precisamos
apenas do atributo $x$ (o eixo $y$ √© constru√≠do de forma autom√°tica).

. . .

Na sequ√™ncia, podemos observar um exemplo de histograma das notas dos filmes
da Pixar no Rotten Tomatoes.

. . .

```{r histograma-simples-rotten-tomatoes}
#| fig-align: "center"
#| out.width: "55%"
pixar_avalicao_publico |> 
  ggplot() +
  aes(x = nota_rotten_tomatoes) +
  geom_histogram()
```


## Exemplo de histograma "mais bonito"

```{r histograma-rotten-tomatoes}
#| fig-align: "center"
#| out.width: "100%"
pixar_avalicao_publico |> 
  ggplot() +
  aes(x = nota_rotten_tomatoes) +
  geom_histogram(fill = "cyan4") +
  labs(x = "Nota segundo cr√≠ticos do Rotten Tomatoes",
       y = "Contagem",
       title = "Como se distribuem as notas segundo os cr√≠ticos do Rotten Tomatoes?",
       subtitle = "Dados de 24 filmes da Pixar",
       caption = "Fonte: Wikipedia") +
  theme_light(base_size = 16, base_family = "Charter")
```

## Box plot

Os box plots s√£o √∫teis para estudar a distribui√ß√£o de uma vari√°vel,
especialmente ao comparar v√°rias distribui√ß√µes.

. . .

Para construir um box plot, usamos o `geom_boxplot()`. Para tal, usamos
atributos $x$ e $y$, mapeando uma vari√°vel categ√≥rica para o atributo $x$.

. . .

```{r boxplot-gapminder}
#| fig-align: "center"
#| out.width: "60%"
dados_gapminder |> 
  filter(ano == 1952) |> 
  ggplot() +
  aes(x = continente, y = expectativa_de_vida) +
  geom_boxplot()
```

## Box plot ap√≥s ajustes

```{r boxplot-apos-ajustes}
#| fig-align: "center"
dados_gapminder |> 
  filter(ano == 1952) |> 
  ggplot() +
  aes(x = continente, y = expectativa_de_vida, color = continente) +
  geom_boxplot(show.legend = FALSE) +
  theme_classic(base_size = 16, base_family = "Charter") +
  labs(x = "Continente", y = "Expectativa de vida (em anos)",
       title = "Como se distribu√≠a a expectativa de vida em cada continente em 1952?",
       caption = "Fonte: Gapminder") +
  annotate("text", x = 1, y = 65,
           label = "Em 1952,\na √Åfrica tinha\numa expectativa\nde vida\nde 38,8 anos.",
           size = 5,
           family = "Charter")
```

## T√≠tulos, labels e escalas

Para colocar t√≠tulos ou trocar os labels (r√≥tulos) dos atributos, utilizamos
a fun√ß√£o `labs()`.

. . .

Para mudar as escalas (textos e quebras), usamos as fun√ß√µes da fam√≠lia
`scale_[est√©tica]_[op√ß√£o]()`.

. . .

Para definir qual por√ß√£o do gr√°fico deve ser mostrada (limites), podemos usar
as fun√ß√µes `xlim()` e `ylim()`.

## Cores

Para escolher manualmente as cores que coloriram ou preencheram um plot,
use as fun√ß√µes `scale_color_manual()` ou `scale_fill_manual()`.

. . . 

Para trocar o nome das legendas geradas por atributos de cor,
use as fun√ß√µes `scale_color_discrete()` ou `scale_fill_discrete()`.

## Temas

Como voc√™s devem ter percebido, o `ggplot2` traz consigo alguns temas prontos
a partir de fun√ß√µes da fam√≠lia `theme_[estilo_do_tema]`.

. . .

Voc√™ tamb√©m pode criar o seu pr√≥prio tema usando a fun√ß√£o `theme()`.
N√£o teremos
como ver durante as aulas, pois requer um pouco mais de conhecimento
t√©cnico, mas √© um processo divertido de aprender!

## Dica: Extens√µes do `ggplot2`

* O `ggplot2` √© muito potente, mas n√£o possui todos os gr√°ficos poss√≠veis

* Por conta disso, a comunidade desenvolve extens√µes que v√£o desde pacotes
com novos temas ou cores, geometrias, eixos ou at√© a
[possibilidade de criar calend√°rios customizados](https://r-coder.com/calendar-plot-r/) üòÇ

* A equipe do Tidyverse mant√©m uma [lista curada de extens√µes do `ggplot2`](https://exts.ggplot2.tidyverse.org/gallery/)

. . .

```{r calendario-mes-abril}
#| echo: false
#| fig-align: "center"
#| out.width: "60%"
calendR::calendR(year = 2023, month = 04,
        special.days = c(17, 24),
        special.col = "#bfe2f2",
        low.col = "white",
        title = "Aulas de R no m√™s de abril de 2023",
        subtitle = "Exclusivas para o grupo de pesquisa Alliance",
        weeknames = c("Segunda", "Ter√ßa",
                      "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"),
        lunar = FALSE)
```

## Tarefa de casa

* A partir dos dados `pinguins` do pacote `dados`, crie:
  - Um gr√°fico de pontos (dispers√£o)
  - Um box plot (vari√°vel num√©rica estratificada por uma vari√°vel categ√≥rica)
  - Um histograma
  
* Escolha um dos seus gr√°ficos para ajust√°-lo e deix√°-lo visualmente mais
agrad√°vel!
  - Ajustar r√≥tulos, tamanho da fonte, cores, adicionar t√≠tulo, e o que
  mais voc√™ achar importante
  - Lembre-se da fun√ß√£o `labs()` e fam√≠lia `theme_[estilo_do_tema]()`
  
## Dica de leitura sobre visualiza√ß√£o

::: columns
::: {.column width="50%"}
* [Data Visualization: A Practical Introduction](https://socviz.co/)
  - Como criar visualiza√ß√µes efetivas
  - Quais visualiza√ß√µes funcionam e quais n√£o
  - Como criar v√°rios tipos de gr√°ficos em `ggplot2`
  - Como refinar os gr√°ficos para apresenta√ß√£o
:::

::: {.column width="50%"}
![](../assets/capa_data_visualization.jpg){fig-align="center" width=90%}
:::
:::

## Refer√™ncias

::: {#refs}
:::